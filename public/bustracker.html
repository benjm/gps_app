
<!DOCTYPE html>
<html>
<head>

<!-- references
http://stackoverflow.com/questions/9922101/get-json-data-from-external-url-and-display-a-particular-value-by-injecting-it-i
https://developers.google.com/maps/documentation/javascript/examples/map-simple
https://developers.google.com/maps/documentation/javascript/examples/marker-simple
-->

<title>Ben's BusTracker</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta charset="utf-8">
<style>
html,body,#map-canvas {
	height: 100%;
	margin: 0px;
	padding: 0px
}
</style>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script>

//max -0.208826 to -0.251999
//max 51.7757 to 51.755117

	// bus icon settings
	var id_to_icon = {};
	id_to_icon['HTC Desire C'] = 'black.png';
	id_to_icon['HTC Desire S'] = 'red.png';

	// map borders
    var maxLat = 51.7757;
    var minLat = 51.755117;
    var maxLng = -0.208826;
    var minLng = -0.251999;
    //var minLng = -0.235; // for testing
    var normalBounds = new google.maps.LatLngBounds(new google.maps.LatLng(minLat, minLng), new google.maps.LatLng(maxLat, maxLng));
    
    var normalZone = new google.maps.Rectangle({
        strokeColor: '#22DD22',
        strokeOpacity: 0.7,
        strokeWeight: 2,
        fillColor: '#22DD22',
        fillOpacity: 0.1,
        bounds: normalBounds
      });
    
	var llStation = new google.maps.LatLng(51.76373, -0.215564);
	var llTitan = new google.maps.LatLng(51.762488, -0.243518);
	var map;
	var markers = new Array();
	
	function initialize() {

		var mapOptions = {
			zoom : 14,
			center : new google.maps.LatLng(51.764, -0.230)
		};

		map = new google.maps.Map(document.getElementById('map-canvas'),
				mapOptions);

		var marker = new google.maps.Marker({
			position : llStation,
			map : map,
			title : 'Station'
		});

		var marker = new google.maps.Marker({
			position : llTitan,
			map : map,
			title : 'Titan'
		});

	    setInterval(refreshJson, 2200);
	}
	
	function howLong(tsString) {
        var d = Date.parse(tsString);
        var now = Date.now();
        var seconds = ((now - d) / 1000) >> 0;
        return seconds;
	}
	
	function formatinHMS(seconds) {
        var s = (seconds % 60);
        var m = ((seconds / 60) % 60) >> 0;
        var h = (seconds / 3600) >> 0;
        var hstr = String("0" + h).slice(-2);
        var mstr = String("0" + m).slice(-2);
        var sstr = String("0" + s).slice(-2);
        return hstr + ':' + mstr + ':' + sstr;
	}
	
	function getRouteImage(device_id) {
		return id_to_icon[device_id] || 'green.png';
	}
	
    function refreshJson() {
	    $.getJSON('http://agile-journey-4782.herokuapp.com/getdata/ocado?callback=?', function(jd) {
	        var now = new Date();
	        var myObject = eval(jd);
	        $('#info').html('Server last checked at ['+now+']<p>');
	        var oneIsOutside = false;
	        for ( var i in myObject) {
	            var ll = new google.maps.LatLng(myObject[i].latitude,myObject[i].longitude)
	            var delta = howLong(myObject[i].timestamp);
                var image = getRouteImage(route);
                
	            $('#info').append('<img src='+image+'> [' + myObject[i].route + '] last reported ['+formatinHMS(delta)+'] ago');
	            
	            var route = myObject[i].route;
	            var marker = markers[route];
                //$('#info').append('<li>[marker='+marker+']</li>');
	            if (marker === null || marker === undefined) {
		            marker = new google.maps.Marker({
		                position : ll,
		                map : map,
		                title : route,
		                icon: image
		            });
		            markers[route] = marker;
	            } else {
	            	marker.setPosition(ll);
	            }
	            if (!normalBounds.contains(ll)) {
	            	oneIsOutside = true;
	                $('#info').append(' and is outside the normal (shaded) area');
	            }
	            $('#info').append('<br>');
	        }
	        
	        if (myObject.length == 0) {
	            $('#info').append('There is no bus info - maybe the phones are off...');
	        }
            
            if (oneIsOutside) {
                normalZone.setMap(map);
            } else {
                normalZone.setMap(null);
            }
	        $('#info').append('</p><br>');
	    });
    }

	$(document).ready(function() {
		$("#driver").click(function(event) {
			refreshJson();
		});
	});

    google.maps.event.addDomListener(window, 'load', initialize);
	
</script>
</head>
<body>
	<div id="info" style="background-color: #EEE;"></div>
	<div id="controls" style="background-color: #EEE;">
		<!-- <input type="button" id="driver" value="Refresh" /> -->
	</div>
	<div id="map-canvas"></div>
</body>
</html>
