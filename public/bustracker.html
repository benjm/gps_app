
<!DOCTYPE html>
<html>
<head>

<!-- references
http://stackoverflow.com/questions/9922101/get-json-data-from-external-url-and-display-a-particular-value-by-injecting-it-i
https://developers.google.com/maps/documentation/javascript/examples/map-simple
https://developers.google.com/maps/documentation/javascript/examples/marker-simple
-->

<title>Ben's BusTracker</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta charset="utf-8">
<!-- TODO 100% height map with semi-transparent info overlay. the css below just about manages it but with a defined number of pixels height for the map -->
<style type="text/css">
html,body {
	height: 100%;
    width: 100%;
	margin: 0px;
	padding: 0px
}
#container {
    width: 100%;
    height: 400px;
    min-height: 400px;
    max-height: 1080px;
    position: relative;
}
#map-canvas {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
}

#info {
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 10;
    opacity: 0.7;
}
</style>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script>

//max -0.208826 to -0.251999
//max 51.7757 to 51.755117

	// bus icon settings
	var id_to_png = {};
	id_to_png['HTC Desire C'] = 'black';
	id_to_png['GT-I8190N'] = 'black';
	id_to_png['blackberry'] = 'black';
	id_to_png['HTC Desire S'] = 'red';
	id_to_png['strawberry'] = 'red';

	var id_to_clr = {};
	id_to_clr['HTC Desire C'] = '#111';
	id_to_clr['GT-I8190N'] = '#111';
	id_to_clr['blackberry'] = '#111';
	id_to_clr['HTC Desire S'] = '#D11';
	id_to_clr['strawberry'] = '#D11';

	// map borders
    var maxLat = 51.7757;
    var minLat = 51.755117;
    var maxLng = -0.208826;
    var minLng = -0.251999;
    //var minLng = -0.235; // for testing
    var normalBounds = new google.maps.LatLngBounds(new google.maps.LatLng(minLat, minLng), new google.maps.LatLng(maxLat, maxLng));
    
    var normalZone = new google.maps.Rectangle({
        strokeColor: '#22DD22',
        strokeOpacity: 0.7,
        strokeWeight: 2,
        fillColor: '#22DD22',
        fillOpacity: 0.1,
        bounds: normalBounds
      });
    
	var llStation = new google.maps.LatLng(51.76373, -0.215564);
	var llTitan = new google.maps.LatLng(51.762488, -0.243518);
	var map;
	var markers = new Array();
	var lines = new Array();
	var max_trail = 5;
	
	function initialize() {

		var mapOptions = {
			zoom : 14,
			center : new google.maps.LatLng(51.764, -0.230)
		};

		map = new google.maps.Map(document.getElementById('map-canvas'),
				mapOptions);

		var marker = new google.maps.Marker({
			position : llStation,
			map : map,
			title : 'Station'
		});

		var marker = new google.maps.Marker({
			position : llTitan,
			map : map,
			title : 'Titan'
		});

	    setInterval(refreshJson, 11500);
	}
	
	function howLong(tsString) {
        var d = Date.parse(tsString);
        var now = Date.now();
        var seconds = ((now - d) / 1000) >> 0;
        return seconds;
	}
	
	function formatinHMS(seconds) {
        var s = (seconds % 60);
        var m = ((seconds / 60) % 60) >> 0;
        var h = (seconds / 3600) >> 0;
        var hstr = String("0" + h).slice(-2);
        var mstr = String("0" + m).slice(-2);
        var sstr = String("0" + s).slice(-2);
        return hstr + ':' + mstr + ':' + sstr;
	}

	function getAlphaString(n) {
		var i = 1
		if (n < i) {
			return ''
		} else if (n < i+1) {
			return '75'
		} else if (n < i+2) {
			return '50'
		} else {
			return '25'
		}
	}
	
	function getRouteImage(device_id, n) {
		var suffix = '.png'
		var colour = id_to_png[device_id] || 'green';
		var aa = getAlphaString(n)
		var iconn = colour + aa + suffix
		return iconn
	}

	function getOpacity(n) {
		var i = 2
		if (n < i) {
			return 0.4
		} else if (n < i+1) {
			return 0.3
		} else if (n < i+2) {
			return 0.2
		} else {
			return 0.1
		}
	}
	
    function refreshJson() {
	    //$.getJSON('http://agile-journey-4782.herokuapp.com/gethistory/ocado?callback=?', function(jd) {
	    $.getJSON('http://vast-springs-1335.herokuapp.com/gethistory/ocado?callback=?', function(jd) {
	        var now = new Date();
	        var myObject = eval(jd);
	        $('#info').html('Server last checked at ['+now+']<p>');
	        var oneIsOutside = false;
	        var totlength = myObject.length
	        for (var na = 0; na < myObject.length; na++) {
	        	var array = myObject[na].sort(function (r0,r1) {return r1.timestamp.localeCompare(r0.timestamp)}); // hacky compare relies on strings...
	        	var rlabel
	        	var recent
	        	totlength = totlength + array.length
	        	for (var nr = 0; nr < array.length && nr < max_trail; nr++) {
	        		var myInnerObject = array[nr]
	        		var i = myInnerObject.route
	        		rlabel = i
		            var ll = new google.maps.LatLng(myInnerObject.latitude,myInnerObject.longitude)
		            console.log("checking for age: " + myInnerObject.age)
		            var delta = howLong(myInnerObject.timestamp);
	        		if (!recent || recent > delta) {recent = delta;}
	                var image = getRouteImage(i, nr);
		            var route = i + nr;
		            var marker = markers[route];
		            if (marker === null || marker === undefined) {
			            marker = new google.maps.Marker({
			                position : ll,
			                map : map,
			                title : route,
			                icon: image
			            });
			            markers[route] = marker;
		            } else {
		            	marker.setPosition(ll);
		            	marker.setMap(map); // just in case it was hidden
		            }
		            if (!normalBounds.contains(ll)) {
		            	oneIsOutside = true;
		            }
		            
		            if (nr > 0) {
	        			var oldObject = array[nr-1]
		                var oldll = new google.maps.LatLng(oldObject.latitude,oldObject.longitude)
		                //TODO draw or re-draw lines?
		                if (lines[route]) {
			            	lines[route].setMap(null)
			            }
			            var op = getOpacity(nr)
			            var colour = id_to_clr[rlabel] || '#1D1';
			            
			            var line = new google.maps.Polyline({
					       path: [oldll, ll],
					       strokeColor:colour,
					       strokeOpacity:op,
					       strokeWeight:2,
					       map: map
					    });
			            lines[route] = line
		            }
		            
		        }

				//remove old markers
		        if (rlabel) {
			        for (var remn = array.length; markers[rlabel+remn] && (remn < max_trail); remn++) {
			        	var rid = rlabel+remn
			        	var marker = markers[rid]
			        	marker.setMap(null)
			        	//TODO remove old lines if drawn...
			        	var line = lines[rid]
			        	line.setMap(null)
			        }
			    }

		        if (rlabel && recent && recent > 60) {
		        	var image = getRouteImage(rlabel, 0);
		        	$('#info').append('<img src='+image+'> last reported '+formatinHMS(recent)+' ago...<br>');
		        }
	        }

	        if (oneIsOutside) {
	        	$('#info').append('NB: some abnormal location readings. ');
	        }
	        
	        if (totlength == 0) {
	            $('#info').append('There is no bus info!');
	        }
            
            if (oneIsOutside) {
                normalZone.setMap(map);
            } else {
                normalZone.setMap(null);
            }
	        $('#info').append('</p>');
	    });
    }

	$(document).ready(function() {
		$("#driver").click(function(event) {
			refreshJson();
		});
	});

    google.maps.event.addDomListener(window, 'load', initialize);
	
</script>
</head>
<body>
	<div id="container">
		<div id="info" style="background-color: #EEE;"></div>
		<div id="map-canvas"></div>
	</div>
</body>
</html>
